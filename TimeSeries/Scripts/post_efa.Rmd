---
title: "post_efa"
author: "Bernice Cheung"
date: "11/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(psych)
library(ggplot2)
library(knitr)
library(janitor)
library(kableExtra)
library(here)
library(nFactors)
```

load data
```{r}
# load post-rating dataset
postRating_w <- read.csv(here("TimeSeries", "Inputs", "merged_goalRep_post_w.csv"))

postRating_l <- read.csv(here("TimeSeries", "Inputs", "merged_goalRep_post_l.csv"))
```

# Descriptive

```{r}
# descriptive stats for each variable 
mTurk_p_descriptive <- postRating_l %>%
  dplyr::select(variable, post_rating) %>%
  group_by(variable) %>%
  summarize(mean = mean(post_rating, na.rm = TRUE),
            sd = sd(post_rating, na.rm = TRUE), 
            n = n(),
            min = min(post_rating, na.rm = TRUE),
            max = max(post_rating, na.rm = TRUE),
            skew = skew(post_rating, na.rm = T), 
            kurtosi = kurtosi(post_rating, na.rm = T)
            ) %>%
  arrange(skew)

#write.csv(goalRating_long_R, here("Baseline", "Outputs", "goalRating_long_R.csv"), row.names = F)

mTurk_p_descriptive %>%
  kable(format = "html", escape = F) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F,position = "center")
# order based on their skewness 
#kable(varDf[order(varDf$skew),])

#mTurk_p_descriptive <- write.csv(mTurk_p_descriptive, here("TimeSeries", "Outputs", "mTurk_p_descriptive"), row.names = F)
```


```{r fig.width = 10, fig.height=10, warning=FALSE}
# histograms for each dimension
postRating_l %>%
  ggplot(aes(x = post_rating)) +
    geom_histogram(fill   = "orange",
                   colour = "black",
                   alpha  = .6) +
    facet_wrap(~variable, nrow = 7)

```

### correlational matrix across all variables

"pairwise.complete.obs" is used for generating correlation matrix.The correlations make sense
```{r fig.height=20, fig.width=20}
# transform the long format to short format
goalDf_wide <- postRating_l %>% spread (variable, post_rating)

# generate a correctional matrix
corrM_all <- goalDf_wide %>% 
  dplyr :: select(affordance:visibility) %>% 
  cor(use = "pairwise.complete.obs")

# visualization
corrplot(corrM_all, method = "circle",number.cex = .7, order = "AOE", addCoef.col = "black",type = "upper",col= colorRampPalette(c("midnightblue","white", "orange"))(200))

# left_join(goalListDf, goalDf_wide, by = c("MTurkCode","goal_order" = "goal")) %>%
#   write.csv(., here("Baseline", "Outputs", "goalList_rating.csv"),row.names = F)

write.csv(corrM_all,here("TimeSeries", "Outputs","mTurk_p_corrM_all.csv"), row.names = F)
```

### Variance Partition

Only the 31 variables for goal representation are included. Only around 6.7% of the variance is on the between subject level. (less than previous mTurk data)

```{r}
# subset the long format dataset for only the 31 goal representation variable
goal_striving <- c("commitment", "urgency", "effort", "initial_time_R", "regret", "procrastination", "failure", "self_resources", "other_resources", "implementation_intention")
post_goalrep_l <- postRating_l[!postRating_l$variable %in% goal_striving,]

# generate a multilevel model with subject as the random intercept
mlm <-lmer(post_rating ~ variable + (1|MTurkCode), data = post_goalrep_l)

# calculate the variance partition coefficient and transform to ICC
VarCorr(mlm) %>%
  as_tibble() %>%
  mutate(icc=vcov/sum(vcov)) %>%
  dplyr :: select(grp, icc)

Raw <- VarCorr(mlm) %>%
  as_tibble() %>%
  mutate(Raw=vcov/sum(vcov)) %>%
  dplyr :: select(Raw)

# just for paper output
# mTurk_p_icc <- VarCorr(mlm) %>%
#   as_tibble() %>%
#   mutate(mTurk_p_icc=vcov/sum(vcov)) %>%
#   dplyr :: select(mTurk_p_icc)
# 
# mTurk_p_icc$variation <- c("between-subject", "residual")
# 
# write.csv(mTurk_p_icc, here("TimeSeries", "Outputs", "mTurk_p_descriptive.csv"), row.names = F)
```
item wise ICC
```{r}
# create the function
varPartition <- function(var, groupVar, data){
  mlm <- lmer(var ~ 1 + (1|groupVar), data = data)
  
  outputDf <- VarCorr(mlm) %>%
    as_tibble() %>%
    mutate(outputDf=vcov/sum(vcov)) %>%
    dplyr :: select(outputDf)
}

# apply the function to each variable after excluding subjects with just 1 goal
df_cleaned <- postRating_w %>%
  filter(listNum != 1) %>%
  select(-goal, -listNum, -status, -terminate_time, -time_point)


mTurk_p_item_ICC <- df_cleaned %>%
  select(-MTurkCode) %>%
  map(~varPartition(., df_cleaned$MTurkCode, df_cleaned)) %>%
  as_tibble() %>%
  t() %>%
  as.data.frame() %>%
  select(V1) %>%
  rename("mTurk_p_icc" = "V1") %>%
  rownames_to_column("Items")

write.csv(mTurk_p_item_ICC, here("TimeSeries", "Outputs", "mTurk_p_item_ICC.csv"), row.names = F)

```

# EFA

## Data transformation
```{r}
# Exclude 5 goal representation variables and other columns with irrelevant data
goal_exclude <- c("temporal_duration", "end_state_specificity", "frequency", "attainment_maintenance", "approach_avoidance")
post_efa <- postRating_w[,!names(postRating_w) %in% goal_exclude]
post_efa <- subset(post_efa, select = affordance : visibility)

# Generate a correctional matrix 
postM_raw <- cor(post_efa, use = "pairwise")

# write the output
#write.csv(postM_raw, here("TimeSeries","Outputs", "mTurk_p_EFA_raw.csv"), row.names = F)
```


## evaluate the number of factors
```{r}
# use Very Simple Structure criterion
res_vss <- psych :: nfactors(postM_raw, n = 10, rotate = "promax", diagonal = FALSE, fm = "minres", 
n.obs=756,title="Very Simple Structure",use="pairwise",cor="cor")

# select useful parameters and organize them into a table
cbind(1:10, res_vss$map) %>%
  as_tibble() %>%
  rename(., factor = V1, map = V2) %>%
  cbind(., res_vss$vss.stats) %>%
  select(factor, map, fit, complex, eChisq, SRMR, eCRMS, eBIC, eRMS) %>%
  kable(format = "html", escape = F, caption = "VSS output -mTurk") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F,position = "center",fixed_thead = T)

```

```{r}
# Use the Scree plot to identify the number of factors have Eigenvalues >1 and the output from the Parallel analysis

ev <- eigen(postM_raw)
ap <- parallel(subject=nrow(post_efa),var=ncol(post_efa),
  rep=100,cent=.05)
nS <- nScree(x=ev$values, aparallel=ap$eigen$qevpea)
plotnScree(nS)
```


## Extract factors - 4-factor: 

### Extraction: 
```{r}
# extract 4 factors
fa_new_4 <-fa(r=postM_raw, nfactors=4,n.obs = 756, rotate="promax", SMC=FALSE, fm="minres")
```

### Factor loadings
```{r}
fa.diagram(fa_new_4)
```

Difficulty doesn't load well on to any factor (0.29 on Value)
```{r}
# visualization
loadings <- fa.sort(fa_new_4)$loadings
loadings <- as.data.frame(unclass(loadings))
colnames(loadings) <- c("Value","External", "Attainability", "Measurability")
loadings$Items <- rownames(loadings)
loadings.m <- loadings %>% gather(-Items, key = "Factor", value = "Loading")
colOrder <- c("Value","External", "Attainability", "Measurability")
rowOrder <- rev(rownames(loadings))
loadings.m<- arrange(mutate(loadings.m,Items=factor(Items,leve=rowOrder)),Items)
loadings.m<- arrange(mutate(loadings.m,Factor=factor(Factor,leve=colOrder)),Factor)

ggplot(loadings.m, aes(Items, abs(Loading), fill=Loading)) + 
  facet_wrap(~ Factor, nrow=1) + #place the factors in separate facets
  geom_bar(stat="identity") + #make the bars
  coord_flip() + #flip the axes so the test names can be horizontal  
  #define the fill color gradient: blue=positive, red=negative
  scale_fill_gradient2(name = "Loading", 
                       high = "orange", mid = "white", low = "midnightblue", 
                       midpoint=0, guide="colourbar") +
  ylab("Loading Strength") + #improve y-axis label + 
  ggtitle("Four Factor Solution from mTurk Sample 2") +
  geom_hline(yintercept = 0.3, color = "red", linetype="dotted") +
  theme_bw(base_size=10)
```

### interfactor correlation
```{r}
fa_new_4$Phi %>% 
  as.tibble() %>% 
  dplyr::rename(Value = MR1, Attainability = MR2, External = MR3, Measurability = MR4) %>%
  round(.,2) %>%
  remove_rownames() %>%
  mutate(factor = colnames(.)) %>%
  select(factor, everything()) %>%
  kable(format = "html", escape = F, caption = "<center>Factor Correlation of mTurk Sample 2</center>") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F,position = "center",fixed_thead = T)
```

### Model fit
```{r}
data.frame(sample = "mTurk_postRating", factors = 4, items = 26, observation = 756, chi = fa_new_4$chi, BIC = fa_new_4$BIC, fit = fa_new_4$fit, RMSEA = fa_new_4$RMSEA[1], cumVar = max(fa_new_4$Vaccounted[3,]), complexity = mean(fa_new_4$complexity)) %>%
  remove_rownames() %>%
  kable(format = "html", escape = F) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F,position = "center")
```

## 6-factor


### Extraction: 
```{r}
# extract 6 factors
fa_new_6 <-fa(r=postM_raw, nfactors=6,n.obs = 756, rotate="promax", SMC=FALSE, fm="minres")
```

### Factor loadings
```{r}
fa.diagram(fa_new_6)
```

Difficulty doesn't load well on to any factor (0.29 on Value)
```{r}
# visualization
loadings <- fa.sort(fa_new_6)$loadings
loadings <- as.data.frame(unclass(loadings))
colnames(loadings) <- c("Value","Attainability", "External", "Instrumentality", "Measurability", "Commonality")
loadings$Items <- rownames(loadings)
loadings.m <- loadings %>% gather(-Items, key = "Factor", value = "Loading")
colOrder <- c("Value","Attainability", "External", "Instrumentality", "Measurability", "Commonality")
rowOrder <- rev(rownames(loadings))
loadings.m<- arrange(mutate(loadings.m,Items=factor(Items,leve=rowOrder)),Items)
loadings.m<- arrange(mutate(loadings.m,Factor=factor(Factor,leve=colOrder)),Factor)

ggplot(loadings.m, aes(Items, abs(Loading), fill=Loading)) + 
  facet_wrap(~ Factor, nrow=1) + #place the factors in separate facets
  geom_bar(stat="identity") + #make the bars
  coord_flip() + #flip the axes so the test names can be horizontal  
  #define the fill color gradient: blue=positive, red=negative
  scale_fill_gradient2(name = "Loading", 
                       high = "orange", mid = "white", low = "midnightblue", 
                       midpoint=0, guide="colourbar") +
  ylab("Loading Strength") + #improve y-axis label + 
  ggtitle("Four Factor Solution from mTurk Sample 2") +
  geom_hline(yintercept = 0.3, color = "red", linetype="dotted") +
  theme_bw(base_size=10)
```

### interfactor correlation
```{r}
fa_new_6$Phi %>% 
  as.tibble() %>% 
  dplyr::rename(Value = MR1, Attainability = MR2, External = MR3, Measurability = MR4, Commonality = MR5, Instrumentality = MR6) %>%
  round(.,2) %>%
  remove_rownames() %>%
  mutate(factor = colnames(.)) %>%
  select(factor, everything()) %>%
  kable(format = "html", escape = F, caption = "<center>Factor Correlation of mTurk Sample 2</center>") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F,position = "center",fixed_thead = T)
```

### Model fit
```{r}
data.frame(sample = "mTurk_postRating", factors = 6, items = 26, observation = 756, chi = fa_new_6$chi, BIC = fa_new_6$BIC, fit = fa_new_6$fit, RMSEA = fa_new_6$RMSEA[1], cumVar = max(fa_new_6$Vaccounted[3,]), complexity = mean(fa_new_6$complexity)) %>%
  remove_rownames() %>%
  kable(format = "html", escape = F) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F,position = "center")
```

